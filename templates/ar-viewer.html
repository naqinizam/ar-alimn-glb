<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        #debug {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            font-family: Arial;
            z-index: 10000;
            white-space: pre-wrap;
        }
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        Initializing AR...<br>
        <small id="status">Checking compatibility</small>
    </div>

    <div id="debug"></div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; detectionMode: mono; debugUIEnabled: true; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded>

        <!-- Primary Model -->
        <a-entity
            id="chair"
            gltf-model="url(https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Chair/glTF-Binary/Chair.glb)"
            scale="0.3 0.3 0.3"
            position="0 0 -1"
            rotation="0 180 0"
            arjs-anchor>
        </a-entity>

        <a-camera-static></a-camera-static>
    </a-scene>

    <script>
    // Debug elements
    const debug = document.getElementById('debug');
    const loader = document.getElementById('loader');
    const status = document.getElementById('status');
    
    // System check
    function checkCompatibility() {
        let issues = [];
        
        // 1. WebGL support
        if (!AFRAME.utils.device.checkWebGL()) {
            issues.push("‚ùå WebGL not supported");
        }
        
        // 2. WebXR/AR.js
        if (!navigator.xr && !AFRAME.utils.device.checkARSupport()) {
            issues.push("‚ùå AR features not available");
        }
        
        // 3. Camera access
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            issues.push("‚ùå Camera API blocked");
        }
        
        return issues;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        const issues = checkCompatibility();
        
        if (issues.length > 0) {
            status.innerHTML = issues.join("<br>");
            debug.textContent = "DEVICE INCOMPATIBLE:\n" + issues.join("\n");
            return;
        }

        // AR.js events
        const scene = document.querySelector('a-scene');
        const chair = document.getElementById('chair');
        
        // Model loading
        chair.addEventListener('model-loaded', () => {
            loader.style.display = 'none';
            debug.textContent += "\n‚úÖ Model loaded successfully";
        });

        chair.addEventListener('model-error', (e) => {
            const error = e.detail || "Unknown error (check console)";
            debug.textContent += `\n‚ùå Model error: ${JSON.stringify(error)}`;
            status.innerHTML = "Model failed to load<br>Trying alternative...";
            
            // Fallback attempt
            setTimeout(() => {
                chair.setAttribute('gltf-model', {
                    src: 'url(https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Chair/glTF/Chair.gltf)',
                    crossorigin: 'anonymous'
                });
            }, 1000);
        });

        // AR session events
        scene.addEventListener('arjs-video-loaded', () => {
            debug.textContent += "\nüì∑ Camera activated";
            status.textContent = "Point at a flat surface";
        });

        scene.addEventListener('markerFound', () => {
            debug.textContent += "\nüéØ Surface detected";
        });

        // Timeout check
        setTimeout(() => {
            if (loader.style.display !== 'none') {
                debug.textContent += "\n‚ö†Ô∏è Taking too long? Try:\n- Better lighting\n- Different surface\n- Restart Safari";
            }
        }, 15000);
    });
    </script>
</body>
</html>